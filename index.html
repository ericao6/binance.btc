<!DOCTYPE html><html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Delta Real Executado - Multi Corretoras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: monospace;
      margin: 0;
      padding: 0;
      user-select: none;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      background: #222;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    button {
      background: #333;
      border: 1px solid #555;
      color: #eee;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 4px;
    }
    button:hover, button.active {
      background: #00bb88;
      border-color: #00ffbb;
      color: #000;
    }
    #deltaInfo, #balanceText, #volumeTotal {
      text-align: center;
      margin: 10px auto;
      font-size: 16px;
    }
    canvas {
      background: #000;
      display: block;
      margin: 0 auto 40px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button data-window="10000">10s</button>
    <button data-window="30000">30s</button>
    <button data-window="60000" class="active">1min</button>
    <button data-window="300000">5min</button>
    <button data-window="900000">15min</button>
    <button data-window="3600000">1h</button>
    <button data-window="14400000">4h</button>
    <button data-window="86400000">1 dia</button>
    <button data-window="604800000">1 semana</button>
    <button data-window="2592000000">1 mÃªs</button>
    <button data-window="31536000000">1 ano</button>
    <button id="exportCsv">Exportar CSV</button>
  </div>  <h2 style="text-align:center;">ðŸŽ¯ Delta Real Executado - 9 Corretoras</h2>
  <div id="deltaInfo">Calculando delta real...</div>
  <div id="balanceText"></div>
  <div id="volumeTotal"></div>
  <canvas id="combinedCanvas" width="1000" height="500"></canvas>  <script>
    const canvas = document.getElementById('combinedCanvas');
    const ctx = canvas.getContext('2d');
    const deltaInfo = document.getElementById('deltaInfo');
    const balanceText = document.getElementById('balanceText');
    const volumeTotal = document.getElementById('volumeTotal');
    const buttons = document.querySelectorAll('#controls button[data-window]');
    const exportBtn = document.getElementById('exportCsv');

    let windowMS = 60000;
    const trades = [];
    const deltaHistory = [];

    const exchanges = [
      { name: 'Binance', url: 'wss://stream.binance.com:9443/ws/btcusdt@aggTrade', side: d => d.m ? 'sell' : 'buy', qty: d => parseFloat(d.q) },
    ];

    function addTrade(side, qty) {
      trades.push({ side, qty, ts: Date.now() });
    }

    function updateDelta() {
      const now = Date.now();
      const recentTrades = trades.filter(t => now - t.ts < windowMS);
      while(trades.length && now - trades[0].ts > windowMS) trades.shift();

      let buyVol = 0, sellVol = 0;
      recentTrades.forEach(t => {
        if (t.side === 'buy') buyVol += t.qty;
        else sellVol += t.qty;
      });

      const delta = buyVol - sellVol;
      deltaHistory.push({ delta, ts: now });
      if (deltaHistory.length > 100) deltaHistory.shift();

      const totalVol = buyVol + sellVol;
      const percBuy = totalVol ? (buyVol / totalVol) * 100 : 0;
      const percSell = 100 - percBuy;
      const basePrice = 67000;
      const target = basePrice + delta * 0.5;

      deltaInfo.textContent = `ðŸ’¬ Delta (${(windowMS/1000).toFixed(0)}s): ${delta.toFixed(2)} | ðŸŽ¯ Alvo IA: $${target.toFixed(2)}`;
      balanceText.textContent = `ðŸŸ¢ ${percBuy.toFixed(1)}% / ðŸ”´ ${percSell.toFixed(1)}%`;
      volumeTotal.textContent = `ðŸ“Š Volume: Buy = ${buyVol.toFixed(2)} | Sell = ${sellVol.toFixed(2)}`;

      drawChart(buyVol, sellVol, target);
    }

    function drawChart(buy, sell, target) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const max = Math.max(buy, sell, 1);
      const metaBuy = buy + max * 0.2;
      const metaSell = sell + max * 0.2;

      // Barras
      ctx.fillStyle = '#00ff88';
      const hBuy = (buy / max) * 300;
      ctx.fillRect(150, canvas.height - hBuy - 100, 300, hBuy);
      ctx.fillStyle = '#ff4444';
      const hSell = (sell / max) * 300;
      ctx.fillRect(550, canvas.height - hSell - 100, 300, hSell);

      // Linhas de meta
      ctx.strokeStyle = '#ffff00';
      ctx.beginPath();
      ctx.moveTo(150, canvas.height - (metaBuy / max) * 300 - 100);
      ctx.lineTo(450, canvas.height - (metaBuy / max) * 300 - 100);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(550, canvas.height - (metaSell / max) * 300 - 100);
      ctx.lineTo(850, canvas.height - (metaSell / max) * 300 - 100);
      ctx.stroke();

      // Texto alvo
      ctx.fillStyle = '#00ffff';
      ctx.font = '16px monospace';
      ctx.fillText(`ðŸŽ¯ Alvo IA: $${target.toFixed(2)}`, 400, 30);
    }

    // WebSocket exemplo (Binance)
    exchanges.forEach(ex => {
      const ws = new WebSocket(ex.url);
      ws.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          const side = ex.side(d);
          const qty = ex.qty(d);
          if (side && qty) addTrade(side, qty);
        } catch (err) {
          console.error(ex.name, err);
        }
      };
    });

    setInterval(updateDelta, 1000);

    // BotÃµes de timeframe
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        windowMS = parseInt(btn.getAttribute('data-window'));
        deltaHistory.length = 0;
        trades.length = 0;
      });
    });

    // Exportar CSV
    exportBtn.addEventListener('click', () => {
      if (!deltaHistory.length) return alert('Sem dados');
      let csv = 'timestamp,delta\n';
      deltaHistory.forEach(d => {
        csv += `${new Date(d.ts).toISOString()},${d.delta}\n`;
      });
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `delta_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });
  </script></body>
</html>
